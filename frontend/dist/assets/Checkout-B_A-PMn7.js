import{c as J,h as w,r,z as x,j as e,q as T,B as E,P as F,u as K,b as V,d as W,s as Y}from"./index-rlvyAQjv.js";import{P as _,S as Z}from"./shippingService-DcU-EXS8.js";import{P as ee}from"./paymentService-_WYo1tQy.js";import{S as se}from"./square-pen-K6U9dNr8.js";import{T as te,X as ae}from"./couponService-PfZoteme.js";import{S as re}from"./save-BeV_G0NF.js";import{C as ne}from"./CouponInput-DbN0UGcU.js";import{S as O}from"./settings-CWLjUmbf.js";import{C as ie}from"./circle-check-big-DdjFDCqz.js";import{T as le}from"./truck-DlIyHYNf.js";import{C as oe}from"./credit-card-CpIeBnpi.js";/**
 * @license lucide-react v0.555.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ce=[["path",{d:"M11.525 2.295a.53.53 0 0 1 .95 0l2.31 4.679a2.123 2.123 0 0 0 1.595 1.16l5.166.756a.53.53 0 0 1 .294.904l-3.736 3.638a2.123 2.123 0 0 0-.611 1.878l.882 5.14a.53.53 0 0 1-.771.56l-4.618-2.428a2.122 2.122 0 0 0-1.973 0L6.396 21.01a.53.53 0 0 1-.77-.56l.881-5.139a2.122 2.122 0 0 0-.611-1.879L2.16 9.795a.53.53 0 0 1 .294-.906l5.165-.755a2.122 2.122 0 0 0 1.597-1.16z",key:"r04s7s"}]],de=J("star",ce),S={getAll:async()=>(await w.get("/addresses")).data,getById:async o=>(await w.get(`/addresses/${o}`)).data,create:async o=>(await w.post("/addresses",o)).data,update:async(o,p)=>{await w.put(`/addresses/${o}`,p)},delete:async o=>{await w.delete(`/addresses/${o}`)}},U=({onUpdate:o,allowSelection:p=!1,onSelect:c})=>{const[z,D]=r.useState([]),[k,n]=r.useState(!0),[N,h]=r.useState(!1),[g,b]=r.useState(null),[a,i]=r.useState(y());r.useEffect(()=>{f()},[]);const f=async()=>{try{n(!0);const s=await S.getAll();D(s),o&&o(s)}catch{x.error("Erro ao carregar endereços.")}finally{n(!1)}};function y(){return{name:"Casa",receiverName:"",zipCode:"",street:"",number:"",complement:"",neighborhood:"",city:"",state:"",reference:"",phoneNumber:"",isDefault:!1}}const P=s=>s.replace(/\D/g,"").replace(/^(\d{5})(\d)/,"$1-$2").slice(0,9),j=s=>{const l=s.replace(/\D/g,"");return l.length>10?l.replace(/^(\d{2})(\d{5})(\d{4}).*/,"($1) $2-$3"):l.length>5?l.replace(/^(\d{2})(\d{4})(\d{0,4}).*/,"($1) $2-$3"):l.length>2?l.replace(/^(\d{2})(\d{0,5}).*/,"($1) $2"):l},A=(s=null)=>{s?(b(s),i(s)):(b(null),i(y())),h(!0)},$=async s=>{s.preventDefault();const l=x.loading("Salvando...");try{g?await S.update(g.id,a):await S.create(a),x.success("Endereço salvo!",{id:l}),h(!1),f()}catch{x.error("Erro ao salvar.",{id:l})}},I=async s=>{if(window.confirm("Excluir este endereço?"))try{await S.delete(s),x.success("Endereço removido."),f()}catch{x.error("Erro ao excluir.")}},u=async()=>{if(a.zipCode.length>=8)try{const s=a.zipCode.replace(/\D/g,""),m=await(await fetch(`https://viacep.com.br/ws/${s}/json/`)).json();m.erro||i(R=>({...R,street:m.logradouro,neighborhood:m.bairro,city:m.localidade,state:m.uf}))}catch(s){console.error("Erro CEP",s)}};return k?e.jsx("div",{className:"p-4 text-center text-sm text-gray-500",children:"Carregando endereços..."}):e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("h3",{className:"font-bold text-gray-700 flex items-center gap-2",children:[e.jsx(T,{size:18})," Endereços Cadastrados"]}),e.jsxs(E,{size:"sm",onClick:()=>A(),variant:"outline",className:"text-primary border-primary/30 hover:bg-primary/5",children:[e.jsx(_,{size:16})," Novo"]})]}),e.jsxs("div",{className:"grid gap-3 max-h-[60vh] overflow-y-auto pr-1",children:[z.map(s=>e.jsx("div",{className:`bg-white p-4 rounded-lg border transition-all ${s.isDefault?"border-primary/50 bg-primary/5":"border-gray-200"}`,children:e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{className:"cursor-pointer flex-grow",onClick:()=>p&&c&&c(s),children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx("span",{className:"font-bold text-gray-800",children:s.name}),s.isDefault&&e.jsxs("span",{className:"bg-primary/10 text-primary text-[10px] px-2 py-0.5 rounded-full font-bold flex items-center gap-1",children:[e.jsx(de,{size:10,fill:"currentColor"})," Padrão"]})]}),e.jsxs("p",{className:"text-gray-600 text-xs",children:[s.street,", ",s.number," ",s.complement]}),e.jsxs("p",{className:"text-gray-600 text-xs",children:[s.neighborhood,", ",s.city," - ",s.state]}),e.jsxs("p",{className:"text-gray-500 text-[10px] mt-1",children:["CEP: ",s.zipCode]})]}),e.jsxs("div",{className:"flex gap-1 ml-2",children:[e.jsx("button",{onClick:()=>A(s),className:"p-1.5 text-gray-400 hover:text-primary hover:bg-primary/10 rounded",children:e.jsx(se,{size:16})}),e.jsx("button",{onClick:()=>I(s.id),className:"p-1.5 text-gray-400 hover:text-red-600 hover:bg-red-50 rounded",children:e.jsx(te,{size:16})})]})]})},s.id)),z.length===0&&e.jsx("div",{className:"text-center py-6 text-gray-400 text-sm border-2 border-dashed rounded-lg",children:"Nenhum endereço encontrado."})]}),N&&e.jsx("div",{className:"fixed inset-0 bg-black/50 backdrop-blur-sm z-[60] flex items-center justify-center p-4",children:e.jsxs("div",{className:"bg-white rounded-xl shadow-2xl w-full max-w-lg max-h-[90vh] overflow-y-auto animate-in fade-in zoom-in duration-200",children:[e.jsxs("div",{className:"p-5 border-b flex justify-between items-center sticky top-0 bg-white z-10",children:[e.jsxs("h3",{className:"font-bold text-gray-800",children:[g?"Editar":"Novo"," Endereço"]}),e.jsx("button",{onClick:()=>h(!1),children:e.jsx(ae,{className:"text-gray-400 hover:text-gray-600"})})]}),e.jsxs("form",{onSubmit:$,className:"p-5 space-y-3",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"col-span-2",children:[e.jsx("label",{className:"text-xs font-bold text-gray-500",children:"Nome (Ex: Casa)"}),e.jsx("input",{className:"input-base",required:!0,value:a.name,onChange:s=>i({...a,name:s.target.value})})]}),e.jsxs("div",{className:"col-span-2",children:[e.jsx("label",{className:"text-xs font-bold text-gray-500",children:"Quem recebe?"}),e.jsx("input",{className:"input-base",required:!0,value:a.receiverName,onChange:s=>i({...a,receiverName:s.target.value})})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-bold text-gray-500",children:"CEP"}),e.jsx("input",{className:"input-base",required:!0,value:a.zipCode,onChange:s=>i({...a,zipCode:P(s.target.value)}),onBlur:u,maxLength:9})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-bold text-gray-500",children:"Telefone"}),e.jsx("input",{className:"input-base",required:!0,value:a.phoneNumber,onChange:s=>i({...a,phoneNumber:j(s.target.value)}),maxLength:15})]}),e.jsxs("div",{className:"col-span-2",children:[e.jsx("label",{className:"text-xs font-bold text-gray-500",children:"Rua"}),e.jsx("input",{className:"input-base",required:!0,value:a.street,onChange:s=>i({...a,street:s.target.value})})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-bold text-gray-500",children:"Número"}),e.jsx("input",{className:"input-base",required:!0,value:a.number,onChange:s=>i({...a,number:s.target.value})})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-bold text-gray-500",children:"Comp."}),e.jsx("input",{className:"input-base",value:a.complement,onChange:s=>i({...a,complement:s.target.value})})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-bold text-gray-500",children:"Bairro"}),e.jsx("input",{className:"input-base",required:!0,value:a.neighborhood,onChange:s=>i({...a,neighborhood:s.target.value})})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-2",children:[e.jsxs("div",{className:"col-span-2",children:[e.jsx("label",{className:"text-xs font-bold text-gray-500",children:"Cidade"}),e.jsx("input",{className:"input-base",required:!0,value:a.city,onChange:s=>i({...a,city:s.target.value})})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-bold text-gray-500",children:"UF"}),e.jsx("input",{className:"input-base uppercase",required:!0,maxLength:2,value:a.state,onChange:s=>i({...a,state:s.target.value})})]})]})]}),e.jsxs("div",{className:"flex items-center gap-2 pt-2",children:[e.jsx("input",{type:"checkbox",id:"def_modal",className:"w-4 h-4",checked:a.isDefault,onChange:s=>i({...a,isDefault:s.target.checked})}),e.jsx("label",{htmlFor:"def_modal",className:"text-sm",children:"Endereço padrão"})]}),e.jsxs("div",{className:"flex justify-end gap-2 pt-4",children:[e.jsx(E,{type:"button",variant:"ghost",onClick:()=>h(!1),children:"Cancelar"}),e.jsxs(E,{type:"submit",children:[e.jsx(re,{size:16})," Salvar"]})]})]})]})}),e.jsx("style",{children:".input-base { width: 100%; border: 1px solid #e5e7eb; border-radius: 0.5rem; padding: 0.5rem; font-size: 0.875rem; outline: none; transition: border-color 0.2s; } .input-base:focus { border-color: var(--color-primary); ring: 2px solid var(--color-primary); }"})]})};U.propTypes={onUpdate:F.func,allowSelection:F.bool,onSelect:F.func};const Ce=()=>{var M;const[o,p]=r.useState([]),[c,z]=r.useState(null),[D,k]=r.useState([]),[n,N]=r.useState(null),[h,g]=r.useState(!1),[b,a]=r.useState(!0),[i,f]=r.useState(!1),[y,P]=r.useState(!1),{cartItems:j,refreshCart:A}=K(),$=V(),I=W(),[u,s]=r.useState(((M=I.state)==null?void 0:M.coupon)||null);r.useEffect(()=>{!b&&j.length===0&&$("/carrinho",{replace:!0})},[j,b,$]);const l=async()=>{try{const t=await S.getAll();p(t),!c&&t.length>0&&m(t.find(d=>d.isDefault)||t[0])}catch{x.error("Erro ao carregar endereços.")}finally{a(!1)}};r.useEffect(()=>{l()},[]);const m=async t=>{if(z(t),N(null),k([]),!!t.zipCode){f(!0);try{const d=j.map(C=>({productId:C.productId,quantity:C.quantity})),v=await Z.calculate(t.zipCode,d);k(v),v.length>0&&N(v[0])}catch(d){console.error(d)}finally{f(!1)}}},R=async()=>{var d,v;if(!c||!n)return x.error("Selecione endereço e frete.");P(!0);const t=x.loading("Processando pedido...");try{const{id:C,userId:xe,...Q}=c,X=await Y.checkout({address:Q,couponCode:u==null?void 0:u.code,shippingCost:n.price,shippingMethod:n.name});x.loading("Redirecionando para pagamento...",{id:t});const{url:H}=await ee.createCheckoutSession(X.id);await A(),window.location.href=H}catch(C){x.error(((v=(d=C.response)==null?void 0:d.data)==null?void 0:v.message)||"Erro ao processar.",{id:t}),P(!1)}},B=j.reduce((t,d)=>t+d.totalPrice,0),L=u?B*(u.discountPercentage/100):0,q=n?n.price:0,G=B-L+q;return b?e.jsx("div",{className:"min-h-screen flex items-center justify-center",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-4 border-primary border-t-transparent"})}):e.jsxs("div",{className:"max-w-6xl mx-auto px-4 py-10",children:[e.jsx("h1",{className:"text-3xl font-bold text-gray-900 mb-8",children:"Finalizar Compra"}),e.jsxs("div",{className:"grid lg:grid-cols-3 gap-8",children:[e.jsxs("div",{className:"lg:col-span-2 space-y-8",children:[e.jsxs("section",{className:"bg-white p-6 rounded-xl shadow-sm border border-gray-100",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsxs("h2",{className:"text-lg font-bold text-gray-800 flex items-center gap-2",children:[e.jsx(T,{className:"text-primary"})," Endereço de Entrega"]}),e.jsxs(E,{size:"sm",variant:"ghost",className:"text-primary text-xs gap-1",onClick:()=>g(!0),children:[e.jsx(O,{size:14})," Gerenciar"]})]}),o.length===0?e.jsx("div",{className:"text-center py-8 border-2 border-dashed rounded-lg",children:e.jsx("p",{className:"text-gray-500 mb-4",children:"Nenhum endereço cadastrado."})}):e.jsx("div",{className:"grid md:grid-cols-2 gap-4",children:o.map(t=>e.jsxs("div",{onClick:()=>m(t),className:`cursor-pointer p-4 rounded-lg border-2 transition-all relative ${(c==null?void 0:c.id)===t.id?"border-primary bg-primary/5 ring-1 ring-primary":"border-gray-200 hover:border-primary/50 bg-white"}`,children:[(c==null?void 0:c.id)===t.id&&e.jsx("div",{className:"absolute top-2 right-2",children:e.jsx(ie,{size:22,className:"text-primary",fill:"currentColor",color:"white"})}),e.jsx("div",{className:"font-bold text-gray-800 text-sm mb-1",children:t.name}),e.jsxs("div",{className:"text-sm text-gray-600 leading-snug",children:[t.street,", ",t.number," ",e.jsx("br",{})," ",t.neighborhood," - ",t.city,"/",t.state]})]},t.id))})]}),c&&e.jsxs("section",{className:"bg-white p-6 rounded-xl shadow-sm border border-gray-100 animate-in fade-in",children:[e.jsxs("h2",{className:"text-lg font-bold text-gray-800 flex items-center gap-2 mb-4",children:[e.jsx(le,{className:"text-primary"})," Envio"]}),i?e.jsx("div",{className:"text-sm text-gray-500",children:"Calculando..."}):e.jsx("div",{className:"space-y-3",children:D.map((t,d)=>e.jsxs("label",{className:`flex justify-between items-center p-4 rounded-lg border cursor-pointer transition-colors ${(n==null?void 0:n.name)===t.name?"border-green-500 bg-green-50":"border-gray-200 hover:bg-gray-50"}`,children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("input",{type:"radio",name:"shipping",checked:(n==null?void 0:n.name)===t.name,onChange:()=>N(t),className:"text-green-600"}),e.jsxs("div",{children:[e.jsx("div",{className:"font-bold text-gray-800",children:t.name}),e.jsxs("div",{className:"text-xs text-gray-500",children:["Até ",t.deliveryDays," dias úteis"]})]})]}),e.jsxs("div",{className:"font-bold text-gray-700",children:["R$ ",t.price.toFixed(2)]})]},d))})]})]}),e.jsxs("div",{className:"h-fit bg-white p-6 rounded-xl shadow-lg border border-gray-100 sticky top-24",children:[e.jsx("h3",{className:"font-bold text-xl text-gray-800 mb-6 border-b pb-4",children:"Resumo"}),e.jsxs("div",{className:"mb-6",children:[e.jsx("label",{className:"text-xs font-bold text-gray-500 mb-2 block",children:"CUPOM DE DESCONTO"}),e.jsx(ne,{onApply:s,initialCoupon:u})]}),e.jsxs("div",{className:"space-y-3 text-sm text-gray-600 mb-6",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Subtotal"}),e.jsx("span",{children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(B)})]}),e.jsxs("div",{className:"flex justify-between text-green-600",children:[e.jsx("span",{children:"Desconto"}),e.jsxs("span",{children:["- ",new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(L)]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Frete"}),e.jsx("span",{children:n?new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(q):"--"})]})]}),e.jsxs("div",{className:"flex justify-between items-center text-xl font-extrabold text-gray-900 pt-4 border-t border-gray-100 mb-6",children:[e.jsx("span",{children:"Total"}),e.jsx("span",{className:"text-primary",children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(G)})]}),e.jsxs(E,{onClick:R,isLoading:y,disabled:!c||!n||y,variant:"success",className:"w-full py-4 text-lg shadow-green-500/30",children:[e.jsx(oe,{size:20})," ",y?"Redirecionando...":"Pagar com Stripe"]}),e.jsxs("p",{className:"text-xs text-gray-400 text-center mt-3 flex items-center justify-center gap-1",children:[e.jsx(O,{size:10})," Ambiente Seguro Stripe"]})]})]}),h&&e.jsx("div",{className:"fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4",children:e.jsxs("div",{className:"bg-white w-full max-w-2xl rounded-2xl shadow-2xl max-h-[85vh] overflow-hidden flex flex-col",children:[e.jsxs("div",{className:"p-5 border-b flex justify-between items-center bg-gray-50",children:[e.jsx("h3",{className:"font-bold text-lg text-gray-800",children:"Meus Endereços"}),e.jsx("button",{onClick:()=>g(!1),children:e.jsx(_,{className:"rotate-45 text-gray-400 hover:text-red-500"})})]}),e.jsx("div",{className:"p-6 overflow-y-auto flex-1",children:e.jsx(U,{onUpdate:l})})]})})]})};export{Ce as Checkout};
